# CH12 セキュリティ

## 12.1 ホストレベルのセキュリティ
セキュリティを高める方法
- 外部からの侵入に対するセキュリティを高める
    - 必要なソフトウェアのみインストールし、不要なサービスを起動しない
    - ホストレベルの適切なアクセス制御を行う
    - パケットフィルタリングによりアクセスを制限する
    - セキュリティ情報の確認を頻繁に行い、必要があれば素早く対策を実施する
- 内部からの侵入に対するセキュリティを高める
    - 適切なユーザーパスワード管理を行う
    - スーパーユーザー権限で動作するプログラムを最小限にし、定期的にチェックを行う

### 12.1.1 スーパーサーバの設定と管理
- `デーモン`
    - ネットワークを通じてサービスを提供しているサーバ
    - 常時メモリ上に待機しており、クライアントからの要求を監視する
        - 常時リソースを消費する→デーモン数が多くなると消費するシステムリソースも増える
        - リソース：メモリ、CPU、ディスク領域などのコンピュータシステムの動作に必要となる要素のこと
- `スーパーサーバ`
    - デーモンのリソース消費を管理するために開発されたもの
        - ex. inetd, `xinetd`(大抵、こっち採用されてる)
    - メリット
        - 他のサーバプログラムに変わってサービス要求を監視し、接続が確立した時点で本来のサーバプログラムに要求を引き渡す
        - 必要な時だけここのサーバプログラムを起動することで、メモリなどのリソースを効率的に使える
        - TCP Wrapperと組み合わせることで、アクセス制御を集中的に管理できる
    - デメリット
        - 応答が遅れる
            - すぐ応答する必要があるサーバは、スーパーサーバ経由でなくサーバプログラム自身でサービス要求を監視するべき（`スタンドアローン`）
                - ex. Webサーバ、メールサーバなど
    - スーパーサーバ経由の接続に適したサーバ
            - 接続の頻度が高くないサーバ
                - ex. FTP(File Transfer Protocol)サーバ、Telnetサーバ(ネットワーク越しにCLIに接続するやつ)など

### 12.1.2 xinetdの設定
- `/etc/xinetd.conf`ファイル：全体的な設定
- `/etc/xinetd.d`以下：サービスごとの設定

### 12.1.3 TCP Wrapperによるアクセス制御
- `TCP Wrapper`：ネットワークサービスのアクセス制御を集中的に行うもの
    - 設定ファイル：`/etc/hosts.allow`, `/etc/hosts.deny`
        - どちらにも記述がないホストはアクセス許可される
    - tcpd（デーモン）：telnetdやftpdなどのサーバプログラムに代わってサービス要求を受け取った後、設定に基づいてチェックを行い、接続が許可された場合はそれぞれのサーバプログラムに処理を引き渡す
        - .allowに書いてある→OK
        - .allowに書いてない→.denyに書いてない→OK
        - それ以外はNG

`/etc/hosts.allow`ファイルの記述例
```
sshd: .lpic.jp
ALL: 192.168.2.
```

重要：.allowが先にチェックされる。.allowで許可されたら、.denyは確認しない。

### 12.1.4 開いているポートの確認
- サーバプロセスを起動すると、そのプロセスは特定のポートを開いて接続を待ち受ける
    - 攻撃者は開いているポートがあればそれに接続し、攻撃する
    - 開くポートは最小限にとどめるのが良い
- `netstat`, `ss`, `lsof`コマンドで開いているポートを確認する
- `nmap`
    - ポートスキャン（ネットワーク経由で、開いているポートを確認する行為）をするコマンド
- `fuser`
    - ポートを開いているプロセスを特定する
    - ex. `fuser -n tcp 8080`

### 12.1.5 SUIDが設定されているファイル
- 所有者がrootであるプログラムにSUIDを設定する→一般ユーザが実行してもroot権限でそのプログラムが動く
    - SUIDの設定は最小限にとどめ、設定箇所を把握するべき
    - 身に覚えのないファイルにSUIDが設定されている→システム侵害を受けた可能性がある
- `# find / -perm -u+s -ls`
    - 全ファイルシステムからSUIDが設定されているファイルを見つけ出して表示する
    - `-g+s`はSGIDを、`-o+t`はスティッキービットが設定されているファイルを検索できる

## 12.2 ユーザに対するセキュリティ管理

### 12.2.1 パスワード管理
パスワードに有効期限を設け、ユーザに強制的にパスワード変更させることができる
- `chage`

### 12.2.2 ログインの禁止
- `/etc/nonlogin`ファイルを作成しておくと、rootアカウント以外はログインできなくなる
    - ex. lpicユーザのログインを禁止→`# usermod -s /sbin/nologin lpic`
    - ファイルを直接編集しても構わない。その時は`vipw`コマンドを使うべき。

### 12.2.3 ユーザの切り替え
- root権限が必要な時だけrootユーザとして作業するのが適切
- `su`コマンドで、一時的に別のユーザになれる
    - rootユーザから他のユーザになる場合はパスワードは問われない
    - `exit`で元のユーザに戻れる
        - きちんと戻るようにするべき（おそらく、セキュリティ観点
    - `-`の有無に注意
        - あり→調節ログインした時と同様に環境が初期化される→環境変数等が残らない
        - なし→現在の環境をそのままにユーザを切り替える→環境変数等が残る
    - ユーザ名を省略するとrootユーザになる
        - ex. `su -`

### 12.2.4 sudo
- 特定の管理者コマンドの実行のみを特定のユーザに許可する
    - ex. studentユーザにはshutdownコマンドの実行を許可する
- 一般ユーザにrootユーザのパスワードを知らせる必要がない点がメリット
- `visudo`：sudoコマンドの利用設定を編集する
    - 実行すると`/etc/sudoers`が開かれる

### 12.2.5 システムリソースの制限
1人のユーザがシステムメモリを使い切ってしまったらシステムが停止してまう
故意でなくともバグで起こり得る
- `ulimit`：ユーザが利用できるリソースを制限する

## 12.3 OpenSSH
- `SSH`は、リモートホスト間通信で高いセキュリティを実現するもの
    - 認証機能や暗号化が強力で、ファイル転送やリモート操作を安全に行える
    - 1系と2系があり、`公開鍵暗号方式`の認証アルゴリズムに違いがある
        - 1系：RSA1
        - 2系：`DSA`, `RSA`
- `OpenSSH`
    - Linuxで使われる、OpenBSDグループによるSSHの実装のこと

### 12.3.1 SSHのインストールと設定
- Linuxディストリビューション用のパッケージがあるのでそれらをぶちこむ
- インストールすると、ホストの公開鍵と秘密鍵が作られる（ホスト認証に使われる）
    - ※秘密鍵は絶対に漏らすなよ
- `sshdデーモン`がSSHサーバの機能を提供する
    - 設定ファイルは`/etc/ssh/sshd_config`
- `ssh`コマンド
    - セキュリティ面のメリットが大きい
        - 通信経路が暗号化される→盗聴に対する安全性が高まる
        - ホスト認証を使って接続先のホストの正当性を確認できる
        - ユーザ認証に公開鍵認証が使える

### 12.3.2 ホスト認証
- SSHでは、ユーザ認証に先立って、クライアントがサーバの正当性を確認する`ホスト認証`が行われる
- SSH接続のたびサーバ固有のホスト認証（公開鍵）がサーバからクライアントに送られ、クライアント側で保存されているサーバの公開鍵と比較して、一致するかを確認する
- 初回接続時に限り、サーバから公開鍵をダウンロードして`~/.ssh/known_hosts`に登録する
    - 初回接続時のみ、偽ホストがサーバの公開鍵を奪取してクライアントに送りつけると、なりすましができてしまう

### 12.3.3 公開鍵認証
- パスワード認証と同様、ユーザ認証に使える手段の一つ
- 通信するホスト感で、一対の公開鍵と秘密鍵のペアを使って認証を行う
- あらかじめクライアント側ユーザの公開鍵をサーバに登録しておく必要がある
- `ssh-keygen`：公開鍵と秘密鍵の鍵ペアを作成する
    - `パスフレーズ`：秘密鍵を利用する際の認証用文字列
    - 作成した公開鍵を接続先サーバの`~/.ssh/authorized_keys`ファイルに追加する
- `scp`：SSHを使った安全なファイル転送コマンド

### 12.3.4 SSHの活用
#### scpによるリモートファイルコピー
- ローカルホストのファイルをリモートホストにコピーする例
    - `$ scp /etc/hosts sv3.example.jp:/tmp`
- リモートホストのファイルをローカルホストにコピーする例
    - `$ scp sv3.example.jp:/etc/hosts .`
- リモートホストのログイン名がローカルホストと異なる場合は、ユーザ名を指定する

#### ssh-agent
- 秘密鍵を使う際は毎回パスフレーズを尋ねられる→面倒
    - `ssh-agent`：クライアントで稼働するデーモンプロセスで、秘密鍵をメモリ上に保存しておきパスフレーズの入力を省けるやつ
    - ssh-agent bashのように端末プロセスを起動させたのち、ssh-addで秘密鍵を登録する

#### ポート転送（フォワーディング）
- あるポートに送られてきたTCPパケットを、SSHを使った安全な通信路を経由して、リモートホストの任意のポートに転送すること
- POP3やFTPなど、暗号化されてないプロトコルを使った通信の安全性を高められる
- ex. ローカルホストの10110portに接続すると、SSHで暗号化された経路を辿ってリモートホストpop.example.netの110portに接続できる
    - `$ ssh -f -N -L 10110:pop.example.net:110 student@pop.example.net`
        -f: バックグラウンドで実施
        -N: 転送のみ

- `X11ポート転送`
    - ポート転送の仕組みを使ってリモートホストのXクライアントをローカルホストで動作させること

## 12.4 GnuPGによる暗号化
- GNU Privacy Guard
- ファイルを暗号化したい場合に使うもの
- 公開鍵暗号を受かって、ファイルを暗号化、複合したり、電子署名をしたりできるOSS

### 12.4.1 鍵ペアの作成と失効証明書の作成
- `gpg`
    - GnfuPGをしようするためのコマンド。鍵ペアや失効証明書を作成できる。
- 失効証明書は、鍵を無効化するために使うもの

### 12.4.2 共通鍵を使ったファイルの暗号化
- `gpg -c <file name>`
    - 設定したいパスフレーズを2回入力したのち、暗号化されたファイルが作られる
- 複合：`gpg --decrypt <file name>.gpg`

### 12.4.3 公開鍵を使ったファイルの暗号化

