# Linuxのインストールとパッケージ管理

## ハードディスクのレイアウト設計
### Linuxインストールに必要なパーティション
- パーティション：ハードディスクやSSDを論理的に分けるもの
- Linuxのインストールには最低次の二つのパーティションが必要
    - ルートパーティション
    - スワップ領域
- なぜ分ける？
    - ディスク障害時のリスク分散
    - 障害時にスムーズに復旧させるため
- 下記ディレクトリは、独立したパーティションに割り当てるのが一般的
    - /home: 一般ユーザごとのディレクトリ
    - /var: 各種ログファイルやメールスプールなど、更新頻度の高いファイルの置き場
        - メールスプール：受信用メールサーバ上でメールアドレス宛に届いたメールが溜まるところで，郵便局の私書箱のような場所
        - 膨大なログがルートファイルシステムを食い潰さないように、別パーティションに区分することも
    - /usr: プログラムやライブラリ、ドキュメントの置き場
        - 別パーティションにおくとプログラムが正常動作しない場合もある
        - NFSを使ってコマンドやプログラムを共有する場合、/usrを読み込み専用でマウントするとセキュリティ高めれる
    - /boot: ディスクの先頭パーティションとして区分するのが良いシステムもある。例えばRAIDを利用する時。
        - RAID(Redundant Arrays of Inexpensive Disks): 複数のディスクをひとつのように認識・表示させる技術
            - ディスク故障時にもデータ復旧・アクセスを可能にする安全性の向上や、複数HDDへの分散書き込みによるデータ保存の高速化など、RAIDモード毎に特長があり、用途に合わせて様々なストレージ構築が可能
                - ビジネスシーンなど高い信頼性が必要な場合に利用される
    - EFIシステムパーティション(ESP)：ブートローダやデバイスドライバなどの置き場
        - UEFIを使ったシステムでは必要
            - UEFI: コンピュータ内の各装置を制御するファームウェアとOSの間の通信仕様を定めた標準規格の一つ
                - BIOSに代わるもの
                - UEFI対応ファームウェアを指してUEFIと呼ぶことも
    - スワップ領域: 物理メモリの1~2倍程度割り当てる
    - /(root): 上記以外はルートファイルシステムになる
        - ファイルシステム障害時に復旧しやすくするため、できるだけ小さくしたほうがいい

### パーティションのレイアウト設計
- 設計時に考慮すべきこと
    - 用途が異なるディレクトリを別パーティションに配置する
    - ディスク容量の割り当て配分
    - バックアップ方法
- LVM: 論理ボリューム管理
    - パーティション上にそのままファイルシステムを作成するのではなく、ボリュームグループという仮想ディスクを作成し、その上に仮想的なパーティションを作成する仕組み
        - ディスクの取り扱いやバックアップなどがより柔軟にできる

## ブートローダのインストール
- ブートローダ：ストレージからOSを読み込んで起動するプログラム
- GRUB(GRand Unified Bootloader): Linuxの代表的なブートローダ
    - 特徴
        - 多数のファイルシステムを認識可能
        - シェル機能を持つので、コマンドによる高度な管理が可能
    - how to install: `grub-install`コマンド
        - Ex. /dev/sdaのMBR領域にGRUBをインストールする場合
            - `# grub-install /dev/sda`
            - MBR(master boot record): 起動ドライブの最初のセクタ
                - 起動ドライブ：コンピュータの起動時や再起動時に、OSを読み出して起動するよう指定されたストレージ
                    - 複数の起動可能な装置がある場合はBIOSやUEFIで優先順位を指定する

## 共有ライブラリ管理
- 静的ライブラリ：プログラム作成時にその実行ファイル内に読み込まれるライブラリ
- 共有ライブラリ：プログラムの実行時にロードされ、複数のプログラム間で共有されるライブラリ
    - ダイナミックリンクによって呼び出されるライブラリ、とも言える
    - lib~ .so~ と命名されがち
    - /libや/usr/libに置かれがち

### スタティックリンク＆ダイナミックリンク
- スタティックリンク: コンパイル時点で、コンパイラがライブラリを実行ファイル内に埋め込む
    - よく使われるライブラリは、様々な実行ファイル内に含まれて重複してしまう
- ダイナミックリンク: 実行ファイルへライブラリを埋め込むことはせず、実行時にライブラリの機能を呼び出す方法

### 必要な共有ライブラリの確認
- `ldd`コマンド：ある実行ファイルが必要とする共有ライブラリを調べられる
    - Ex. `$ ldd /bin/cat`
- プログラム実行時：ld.soリンカおよびローダが必要な共有ライブラリを検索、ロードする
    - 検索の順序
    - 環境変数`LD_LIBRARY_PATH`
    - `/etc/ld.so.cache`
    - `/lib`, `/usr/lib`
    - `/etc/ld.so.conf`に検索対象にしたい共有ライブラリのリストを記述しておく(`lib`, `/usr/lib`内のものはデフォの検索対象なので不要)
    - `ldconfig`コマンド: ロード結果のキャッシュファイル(バイナリ形式)を再構築する

## Debianのパッケージ管理
パッケージ：実行プログラム、設定ファイル、ドキュメントを一つにまとめたもの

### パッケージ管理
- Linuxでは二種類の方法がある(両者に互換性はない）
    - Debian形式：`dpkg`コマンドやAPTツールなど
        - `dpkg-reconfigure`: 対話的な設定ができる
    - RPM形式：`rpm`コマンド
### apt-get
- APT(Advanced Packaging Tool)というパッケージ管理ツールに含まれるコマンド
- 特徴：インターネット経由で最新のパッケージの入手、インストール、依存関係の解決ができること
- apt-getでパッケージ管理を始めるには、`/etc/apt/sources.list`にパッケージを管理しているサイトのURLを記述する必要があある
### apt-cache
- パッケージ情報を紹介、検索できる
- `apt`: apt-getとapt-cacheを合わせたようなコマンドで、最近はこれを使うよう推奨されている。

## RPMのパッケージ管理
- `rpm` command
- インストールしないけどカレントディレクトリに展開して中身を確認することができる
    - `rpm2cpio` command

### YUM
- CentOSやFedraのパッケージ管理ツール(ATP的な）
    - `/etc/yum.conf`, `/etc/yum.repos.d`に設定を記述する
    - `yum`コマンド
- RPMパッケージはいくつかのパッケージグループに分類できる
    - YUMではグループ単位でパッケージをインストールできる
    - グループ確認：`yum groups list`
### dnfコマンド
- yumでなくdnfコマンドが使われてきつつある。
- yumと結果は同じ。実行する実体は同じなので。[参考サイト](https://blog.apar.jp/linux/16100/)
### Zypperを使ったパッケージ管理
- openSUSE(Linuxディストロの一つ)のパッケージ管理コマンド

## 仮想化のゲストOSとしてのLinux
### クラウドサービスとインスタンス
- クラウド上の仮想Linuxマシンが主流になりつつある
    - 早い、安い、うまい（リソース拡張が容易）
- クラウドコンピューティングに関して知っておいたほうがいい用語
    - ブロックストレージ：容易に拡張できる仮想ディスクストレージ
    - ゲストOS：仮想マシンにインストールされたOS
    - OSイメージ：インスタンスのテンプレートとなるディスクイメージ
        - ディスクイメージ：ストレージ(外部記憶装置)に保管されているデータを、物理的に先頭から末尾まで丸ごと写し取って一つのファイルに記録したもの
    - インスタンス：クラウド上で動作する個々の仮想マシン
        - D-BusマシンID：ここのインスタンスの識別子
            - `/etc/machine-id`ファイルに格納されている
    - コンテナ：独立したOSのように扱えるアプリケーション実行環境
        - 仮想マシンよりも消費リソースやサイズが小さい
    - アプライアンスコンテナ：特定用途向けにあらかじめWebサーバやデータベースサーバなどが組み込まれた状態で用意されているコンテナイメージ
    - ゲストドライバ：仮想マシンがホストマシン上のデバイスにアクセスする際などに使われるソフトウェア
        - 仮想マシンにインストールして利用する
### インスタンスの初期化
- テンプレから簡単にインスタンスを複製できるが、そのままではサーバごとに異なるべきのホスト名やSSH鍵が重複してしまう
- 上記を解決する仕組みが`Cloud-init`で、次のような情報を設定できる
    - ホスト名
    - SSH公開鍵
    - 一般ユーザ
    - インストールするパッケージ

