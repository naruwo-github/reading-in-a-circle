# Docker

## Dockerの誕生
Dockerの普及
- 仮想環境の性能面の優位性
- 昨今の急速なビジネス変化に対応する道具として、IT技術者に有用性が認められているため
    - ソフトウェア開発者：ビジネス要求をコード化する
    - 運用管理者：ビジネス要求をシステム化する
Dockerのメリット
- ソフトウェア開発者：ハードウェア環境の確保や開発環境構築といった煩わしい作業から解放され、アプリケーション開発に集中できる
- 運用管理者：ハードウェア資源を意識せずに運用、廃棄が迅速に行える環境を持つことができる
    - DevOps環境、イミュータブル・インフラストラクチャなどの実現に貢献
        - DevOps：組織文化とツールにより、開発と運用の協力体制を築き、ビジネスアジリティの向上を目指すという考え方
        - イミュータブル・インフラストラクチャ：一度構築した本番環境には更新やパッチの提供などの変更を加えず稼働させるという考え方
            - 本番環境を変更・更新するときは、本番環境と同じ環境(開発環境)を別に用意しておき、そこで更新・パッチの提供・テストを実施し、問題がなければ入れ替える
            - [【DevOps 用語集】Immutable Infrastructure](https://licensecounter.jp/devops-hub/blog/Immutable/)

## Dockerのもたらす環境
アプリケーションの開発/実行環境のパッケージ化
→これによる迅速な配備や廃棄が可能に

## 新たなITインフラへの移行
- 旧来：寿命が来るまで目的を固定化してITシステムを設計・利用する
- 今後（Docker環境）：柔軟で安定的に作成・変更・廃棄できるシステムを構築し、アジャイルに開発する
- イミュータブル・インフラストラクチャ
    - サーバの状態管理を”しない”運用方法
    - 本番系システムと開発系システムの二系統を持つ
        - 開発用で開発を進め、リリースは現稼働の本番系と入れ替えるようにする
            - 不要になった旧本番系は廃棄する
- Dockerはイミュータブル・インフラストラクチャーの開発系に有用
    - OS環境とアプリケーションの入手、構築、利用、破棄が素早く行える環境のため

## Docker向き不向き
向かないシステム
- ビジネス要件が目まぐるしく変化することが比較的少ない、社会インフラ供給基盤システム
    -Ex. 銀行のオンラインシステム、原子力発電所などの制御システム、鉄道や航空機のチケット予約・販売システム、通信インフラ、、、
向くシステム
- サービスプロバイダ、ホスティングなどのITサービスが日々変化するようなシステム
    - [サービスプロバイダ](https://ja.wikipedia.org/wiki/%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%83%BB%E3%83%97%E3%83%AD%E3%83%90%E3%82%A4%E3%83%80)
    - [ホスティング](https://boxil.jp/mag/a2442/#2442-2-1)

## Dockerの課題
- 大量のDockerコンテナの管理工数
    - 大量のコンテナを正常に稼働させるシステムにには下記が必要
        - Linuxコンテナに関する知識
        - チューニングを含めたLinuxOS上のプロセスの挙動に関する知識
        - コンテナの自動配備
        - 資源管理ソフトウェア
- キャパシティプランニング
    - 一つのコンテナに載せるアプリケーション数に関し、ベストプラクティスの事例が少ない
        - 多くすると可搬性が損なわれる
        - 少なくするとコンテナ数が指数関数的に増大する
- オーケストレーション
    - 商用クローズドソースのプロプライエタリソフトウェアがDocker環境でのオーケストレーションに対応しているかどうかが明確になっていない
        - ベンダーサポートが必要で、ここに不確実性がある
- ミッションクリティカル領域での利用
    - ミッションクリティカルなビジネス系システムで必須となるHAクラスタソフトウェアは、Dockerコンテナを正式にサポートしていない
        - [HAクラスタソフトウェア](https://www.weblio.jp/content/HA%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%BF)
- ライブマイグレーションのサポート
    - Dockerはライブマイグレーションを正式にサポートしていない
        - CRIUプロジェクト内で開発が進められているが、商用利用レベルはまだ
    - [ライブマイグレーション](https://wa3.i-3-i.info/word18180.html)
- 稼働OSの制約
    - DockerのホストOSがLinuxの場合には、その上で稼働するコンテナもLinuxに限定される
    - 現状、単一の物理サーバー上において、ハイパーバイザー型の仮想化ソフトウェアを使わずしてWindowsコンテナとLinuxコンテナを混在稼働させられない

## Dockerコンテナのアーキテクチャ
以前から使われている仮想化ソフトは、複数のOS環境とアプリケーションを一つのファイルとして扱い、可搬性の高い基盤を提供する。
Dockerと比べると、複数OSを集約した場合の性能劣化、OSとアプリケーションを仲立ちする仮想化ソフトウェアの介在による障害発生時の問題切り分けの複雑さがある。
- コンテナごとに分離された空間を提供
    - ＊p28の表1-1にコンテナ管理ソフトの一覧がある
- ハイパーバイザー型の仮想化基盤とコンテナの違い
    - 前者：ハードウェアをシミュレーションしている。ゲストOSは通常のOSの起動、停止と何ら変わらない運用が必要。
        - ゲストOSは、自身の仮想ディスクのマスタブーとレコード領域にブートローダを入れなきゃ動かない
        - OS終了時には正常なシャットダウン手続きを行わないと、仮想ディスクに入ったOS自体が損傷する可能性がある
    - コンテナ：物理マシン上で一般的な「OSブート手順」がない→前者に比べオーバーヘッドが少ないのでコンテナの起動・停止が非常に高速
        - namespaceとcgroupsと呼ばれる資源管理の仕組みを使うことで、単一のOSないの複数のコンテナがプロセスとして稼働するだけ→アプリケーションのプロセスがコンテナごとに分離される
        - プロセスはホストOS上で直接実行される→コンテナ内ではホストOSと同等のCPU性能を発揮できる

## 名前空間(namespace)とは
- プロセスの分離、ファイルシステムへのアクセスの分離を実現可能
    - 空間Aのプロセスからは空間Bのプロセスが見えない、といった制御が可能
- Dockerはコンテナ作成時に以下の名前空間を作ることで複数の分離された環境を実現している
    - ipc(Inter-Process Communication): 内部的なプロセス間通信の分離
    - mnt: プロセスから見えるファイルシステムのマウント情報を分離。`chroot`コマンドに近い動き
        - chroot: https://linuc.org/study/knowledge/420/
    - net: ネットワークの制御。net名前空間ごとにネットワークインターフェースを持つことができるため、複数のコンテナとホスト間でネットワーク通信を行える。
    - pid: プロセスの分離。カーネルが制御しており、親PIDによる子PIDの制御などに利用される。
    - user: ユーザIDとグループIDを分離。user名前空間内ごとに個別のユーザIDとグループIDを保持できる。
    - uts(Unix Time-Sharing System): ホスト名やNISドメイン名などの分離をする。
        - NISドメイン名：あるネットワークに属するUnix系コンピュータを管理するための識別子（WindowsならADみたいな）
- pid名前空間の分離
    - Dockerコンテナ実行→Dockerエンジンがコンテナに対する名前空間を作成
        - ホストOSは各コンテナを其々複数の名前空間に属するプロセスとして見る
        - コンテナ内では同一の名前空間に属するアプリケーションプロセスしか見えない
    - Ex. httpdが動作するコンテナAとvfspdが動作するコンテナBを起動した際、ホストOSがコンテナAにPID1000、コンテナBにPID2000を割り当てたとする。
        - この時各コンテナ内では、httpd/vfspdをPID1と割り振る
- ファイルシステムの分離
    - コンテナ内のファイルシステムは別のファイルシステムを見ることができない
- cgroups (Control Group)
    - 複数コンテナあるとはいえホストOS一台分のハードウェア資源しかない
    - Docker環境は、デフォルトではコンテナがホストOSのリソースを食い潰そうとする
        - これを防ぐ仕組みがcgroupsで、コンテナごとに使用できるハードウェアリソースを制限する機能を提供する
    - Linuxカーネルに実装された資源制御の仕組みで、各コンテナが使用するCPUやメモリなどのハード資源の使用量を制限し、分離された名前空間ごとに設定した歯度資源を割り当てる

## まとめ
- 仮想マシンやゲストOSがない→コンテナに作られたOS環境の起動、停止は高速
- Docker資源の再利用の仕組みが整備されている
- イミュータブル・インフラストラクチャーの根幹技術
- 名前空間により、単一のホストOS上で複数のコンテナによるマルチOS環境を構築
- 名前空間とcgroupsより、分離された環境ごとにハードウェア資源を割り当てられる
- Dockerに関する課題やよくある誤解について
    - [Docker Misconceptions](https://hvops.com/articles/docker-misconceptions/)
