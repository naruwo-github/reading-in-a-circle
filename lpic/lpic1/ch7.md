# CH7 シェルとシェルスクリプト

## 7.1 シェル環境のカスタマイズ

### 環境変数とシェル変数
- 環境変数
    - シェル自身、そのシェルから起動されるすべてのプロセスで有効となる変数
    - シェル変数をexportすることで作れる
    - `env`, `printenv`で表示
- シェル変数
    - そのシェル内でのみ有効となる変数
- `set`で両変数を表示

### シェルのオプション
- オプションの有効/無効：`set -o/+o <option>`
    - `set -o`：設定されているオプション一覧の確認

### エイリアス
コマンドに別名をつけたり、コマンドとオプションをひとまとめにして別のコマンドとして定義したりできる。
- `alias`/`unalias`
    - ex. `alias ls='ls -l'`
        - スペースがシェルに解釈されないように単一引用符で囲っている
- 一時的にエイリアスを使わない場合は、実行するコマンドの前に`\`をつける

### 関数の定義
- コマンド同様、名前を指定して実行する
    - 変数名と名前が区別されないので、重複注意！
    - 定義済みの関数のみを表示：`declare -f`
- 定義したシェル内でのみ呼べる
- `function <func name>(){ <command>; }`
    - ex. シンボリックリンクのファイルのみをリスト表示する関数lslink
        - `function lslink(){ ls -l | grep '^l'; }`
- 引数を渡せる
    - ex. lslinkのディレクトリを引数に渡す版($1は一番目の引数を意味する)
        - `function lslink(){ ls -l $1 | '^l'; }`
- `unset`：関数定義の削除

### bashの設定ファイル
いずれもシェルスクリプト
書籍の表7-2を参照

＊/etc以下の設定ファイルは、全ユーザへ影響
＊ホームディレクトリ以下のファイルは、ユーザごとの設定

### bash起動時における設定ファイルの実行順序

<img src="https://qiita-image-store.s3.amazonaws.com/0/29682/52eb2250-8bb6-a094-c8f0-c0d63aa45d1a.png" alt="order importing bash settings" width="1000px">
出典：https://qiita.com/tatesuke/items/88629e9550b813109964

- ログインシェル：ログイン時に起動するシェル。`ps`で確認すると-bashのように頭に`-`がつく
- 対話型シェル：`bash`や端末エミュレータを起動した時に出るシェル

## 7.2 シェルスクリプト

### シェルスクリプトの基礎
- 実行方法
    - `bash`コマンドに渡す
        - スクリプトファイルには読み取り権限があればいい
    - `source`コマンドを使う
        - `.`で置き換えれる
    - スクリプトファイルに実行権限を付与すると、ファイル名だけでコマンドのように実行できる
        - `chmod a+x xxx` -> `./xxx`
- カレントディレクトリにあるスクリプトを実行するのに`./`をつける理由
    - そのディレクトリにパスが通っていないから
        - →パスの通っているディレクトリ内にあるスクリプトはファイル名だけで実行できる
    - カレントディレクトリにパスを通すのはセキュリティ上御法度
- bashコマンドの引数にシェルスクリプトを指定した場合や、実行権限のあるシェルスクリプトをファイル名指定で実行した場合、bashの子プロセス（サブシェル）が起動し、その上でシェルスクリプトが実行される
    - →新たなbashが起動し、それがスクリプトを処理する
        - →親bashはそれが終わるまで待機する
- sourceや.を使った場合は、元のシェル上でスクリプトが実行される
- `exec <cmd>`
    - シェルスクリプトを実施しているシェルのプロセスが、指定したコマンドのプロセスに置き換わる
- スクリプトに渡す引数
    - bashでは、特殊な変数を用いて引数を参照できる
    - `$0`：シェルスクリプトのファイル名
    - `$1`：第一引数
    - `$N`：第N引数
    - `$#`：引数の数
    - `$@`：すべての引数（スペース区切り）
    - `$*`：すべての引数（区切りは環境変数IFSで指定されたもの）
- 実行結果の戻り値
    - `$?`：コマンドの戻り値の格納先。コマンドを実行するたびに初期化される。
        - 0=正常終了、2=異常終了

### ファイルのチェック
- `test <条件文>` or `[ <条件文> ]`
    - 条件文を評価し、真なら0、偽なら0以外
    - 条件式一覧は表7-4

### 制御構造
- 条件分岐：`if xxx then xxx else xxx fi`
- case文による条件分岐

```bash
case <formula> in
  <val1>)
    <statement1> ;;
  <val2>)
    <statement2> ;;
  :
  :
esac
```
- for
    - `seq`：連続値を自動生成出来る
        - ex. bellow

```bash
for i in `seq 10 15`
do
  echo $i
done
```

- while
    - 条件が満たされている間、doとdoneの間の実行文を実行する
- `read`：標準入力からの入力を受け付ける

### シェルスクリプトの実行環境
- シェルスクリプトの一行目には、`#!/bin/bash`のようにシェルのパスを記述する
- スクリプト内で環境を変更(exportなど)した場合、スクリプトの実行が終わっても、実行元のシェル環境には反映されない
    - 逆に、親シェルでexportされた変数(環境変数)は、スクリプト内で使える
- シェルスクリプトは実行したユーザの権限で動作する
    - セキュリティ上の理由でLinuxではスクリプトファイルに設定されたSUID、SGIDは無視される

